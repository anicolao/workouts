import{e as j,s as u,p as S,g as H}from"./MmFal_i2.js";const A="Programs",T="Starting Strength",W=["Day Name","Exercise Name","Load","Rep Range","RPE","Notes"],N=[["Day A","Back Squat","","3x5","8",""],["Day A","Overhead Press","","3x5","8",""],["Day A","Deadlift","","1x5","9",""]],P=[["Day B","Back Squat","","3x5","8",""],["Day B","Bench Press","","3x5","8",""],["Day B","Power Clean","","5x3","8",""]],U=[W,...N,...P,...N],F=[W,...P,...N,...P],k=U,G=F;async function q(e){const t=await j(e);if(!t)return null;const r=`name='${A}' and '${t}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,l=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(r)}`,n=await(await fetch(l,{headers:{Authorization:`Bearer ${e}`}})).json();return n.files&&n.files.length>0?n.files[0].id:(await(await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:A,mimeType:"application/vnd.google-apps.folder",parents:[t]})})).json()).id}async function x(e,t,r,l){await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${r}:append?valueInputOption=USER_ENTERED`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({values:l})})}async function J(e){const t=await q(e);if(!t)return null;const r=`name='${T}' and '${t}' in parents and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`,l=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(r)}`,n=await(await fetch(l,{headers:{Authorization:`Bearer ${e}`}})).json();if(n.files&&n.files.length>0)return n.files[0].id;console.log("Creating Starting Strength program...");const o=(await(await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:T},sheets:[{properties:{title:"Week 1",gridProperties:{frozenRowCount:1}}},{properties:{title:"Week 2",gridProperties:{frozenRowCount:1}}},{properties:{title:"Week 3",gridProperties:{frozenRowCount:1}}},{properties:{title:"Week 4",gridProperties:{frozenRowCount:1}}}]})})).json()).spreadsheetId;return await fetch(`https://www.googleapis.com/drive/v3/files/${o}?addParents=${t}`,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({})}),await x(e,o,"Week 1",U),await x(e,o,"Week 2",F),await x(e,o,"Week 3",k),await x(e,o,"Week 4",G),o}async function L(e){const t=await q(e);if(!t)return[];const r=`'${t}' in parents and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`,l=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(r)}&fields=files(id,name)`,a=(await(await fetch(l,{headers:{Authorization:`Bearer ${e}`},cache:"no-store"})).json()).files||[],h=[];for(const o of a)try{const d=await M(e,o.id,o.name);h.push(d)}catch(d){console.error(`Failed to parse program ${o.name} (${o.id}):`,d)}return h}async function M(e,t,r){const n=(await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}?fields=sheets(properties(title))`,{headers:{Authorization:`Bearer ${e}`},cache:"no-store"})).json()).sheets||[],a={id:t,name:r,weeks:[]};for(const h of n){const o=h.properties.title;if(o.startsWith("_"))continue;const d=`${o}!A2:F`,$=`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${encodeURIComponent(d)}`,i=(await(await fetch($,{headers:{Authorization:`Bearer ${e}`}})).json()).values||[],f={name:o,days:[]};let p=null;for(const c of i){const[m,E,y,w,R,I]=c;!m||!E||((!p||p.dayName!==m)&&(p={dayName:m,exercises:[]},f.days.push(p)),p.exercises.push({name:E,load:y||"",reps:w||"",rpe:R||"",notes:I||""}))}a.weeks.push(f)}return a}const C="Exercise Catalog",B="Instructions",b="Exercise Catalog",_=["Exercise Name","Muscle Group","Default RPE","Tags"],z=[["Incline Press","Push",8,"Chest, Shoulders, Barbell, Dumbbell"],["Dips","Push",9,"Chest, Triceps, Bodyweight"],["Tricep Overhead Extension","Push",9,"Triceps, Cable, Dumbbell"],["Pull-Up","Pull",9,"Back, Lats, Bodyweight"],["Barbell Row","Pull",8,"Back, Thickness, Barbell"],["Face Pull","Pull",9,"Rear Delt, Rotator Cuff, Cable"],["Back Squat","Squat",6,"Quads, Glutes, Barbell"],["Front Squat","Squat",6,"Quads, Core, Barbell"],["Leg Press","Squat",7,"Quads, Machine"],["Deadlift","Hinge",6,"Hamstrings, Posterior Chain, Barbell"],["Romanian Deadlift","Hinge",7,"Hamstrings, Glutes, Barbell"],["Good Morning","Hinge",7,"Hamstrings, Lower Back, Barbell"]],K=[["Workouts App Configuration"],[""],["Welcome to your configuration sheet! This is where you can customize the exercises available in the app."],[""],["How to use:"],['1. Switch to the "Exercise Catalog" tab at the bottom.'],["2. Add new exercises by typing them into a new row."],["3. Edit existing exercises by changing the text."],['4. "Tags" should be separated by commas.'],[""],["IMPORTANT:"],['- Do NOT rename the "Exercise Catalog" sheet.'],["- Do NOT delete the header row (Row 1)."],["- Changes here will be synced to the app the next time you open it."]];let O=null;function Q(e){return O||(O=X(e).catch(t=>{throw O=null,t})),O}async function X(e){try{const t=await j(e);if(!t)return null;const r=`mimeType='application/vnd.google-apps.spreadsheet' and '${t}' in parents and trashed=false and (name='${b}' or appProperties has { key='type' and value='exercises_config' })`,l=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(r)}`,n=await(await fetch(l,{headers:{Authorization:`Bearer ${e}`}})).json();let a,h=[];if(n.files&&n.files.length>0)a=n.files[0].id,console.log(`Found existing config sheet: ${a}`),h=(await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${a}`,{headers:{Authorization:`Bearer ${e}`}})).json()).sheets||[];else{console.log("Creating new config sheet...");const $=await(await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:b},sheets:[{properties:{title:B}},{properties:{title:C,gridProperties:{frozenRowCount:1}}}]})})).json();return a=$.spreadsheetId,h=$.sheets,await fetch(`https://www.googleapis.com/drive/v3/files/${a}?addParents=${t}`,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({appProperties:{type:"exercises_config"}})}),await v(e,a,B,K),await v(e,a,C,[_,...z]),a}return h.find(d=>d.properties.title===C)||(console.log("Exercise Catalog tab missing, recreating..."),await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${a}:batchUpdate`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({requests:[{addSheet:{properties:{title:C,gridProperties:{frozenRowCount:1}}}}]})}),await v(e,a,C,[_,...z])),a}catch(t){return console.error("Error ensuring config sheet:",t),null}}async function v(e,t,r,l){await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${r}:append?valueInputOption=USER_ENTERED`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({values:l})})}async function Y(e){console.log("Starting initialization and sync..."),u.dispatch(S({type:"sync/start",payload:{timestamp:new Date().toISOString()}}));try{J(e).then(s=>{s&&console.log(`Starting Strength program ensured: ${s}`)}).catch(s=>console.error("Error ensuring Starting Strength:",s)),console.log("Replaying action log...");const t=await H(e);console.log(`Found ${t.length} actions to replay.`),t.forEach(s=>{u.dispatch({type:"workout/processEvent",payload:s.payload,meta:{replay:!0}})}),console.log("Action replay complete."),console.log("Syncing config sheet...");const r=await Q(e);if(!r)throw new Error("Could not ensure config sheet");const n=(await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${r}/values/${C}!A2:D`,{headers:{Authorization:`Bearer ${e}`}})).json()).values||[],a={};n.forEach(s=>{const[g,i,f,p]=s;g&&(a[g]={name:g,muscleGroup:i||"Other",defaultRpe:parseInt(f)||8,tags:p?p.split(",").map(c=>c.trim()).filter(c=>c.length>0):[]})});const h=u.getState(),o=h.workout.exercises||{};console.log(`Current app exercises: ${Object.keys(o).length}`);for(const[s,g]of Object.entries(a)){const i=o[s];let f=!0;if(i){const p=[...g.tags].sort(),c=[...i.tags].sort(),m=c.length===p.length&&c.every((E,y)=>E===p[y]);i.muscleGroup===g.muscleGroup&&i.defaultRpe===g.defaultRpe&&m&&(f=!1)}f&&u.dispatch(S({type:"exercise/upsert",payload:{...g,timestamp:new Date().toISOString()}}))}console.log("Syncing programs...");const d=await L(e),$=h.workout.programs||{};for(const s of d){const g=$[s.id];if(!g){u.dispatch(S({type:"program/upsert",payload:s}));continue}for(let i=0;i<s.weeks.length;i++){const f=s.weeks[i],p=g.weeks[i];if(!p){u.dispatch(S({type:"program/upsert",payload:s}));break}for(let c=0;c<f.days.length;c++){const m=f.days[c],E=p.days[c];if(!E){u.dispatch(S({type:"program/upsert",payload:s}));break}if(m.exercises.length!==E.exercises.length){u.dispatch(S({type:"program/updateDay",payload:{programId:s.id,weekIndex:i,dayIndex:c,day:m}}));continue}for(let y=0;y<m.exercises.length;y++){const w=m.exercises[y],R=E.exercises[y];(w.name!==R.name||w.load!==R.load||w.reps!==R.reps||w.rpe!==R.rpe||w.notes!==R.notes)&&(console.log(`Exercise update detected: Week ${i}, Day ${c}, Ex ${y}`),console.log(`  Current: ${JSON.stringify(R)}`),console.log(`  New:     ${JSON.stringify(w)}`),u.dispatch(S({type:"program/updateExercise",payload:{programId:s.id,weekIndex:i,dayIndex:c,exerciseIndex:y,exercise:w}})))}}}}console.log(`Synced ${d.length} programs.`),console.log("Config and Program sync complete"),u.dispatch(S({type:"sync/success",payload:{timestamp:new Date().toISOString()}}))}catch(t){console.error("Error in initialization/sync:",t),u.dispatch(S({type:"sync/error",payload:{error:String(t),timestamp:new Date().toISOString()}}))}}export{Y as i};
