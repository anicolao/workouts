# Service Worker & Versioning Design

## Objective
To minimize network overhead by caching the application shell and static assets locally, allowing the app to load instantly without network requests. Additionally, to implement a visible versioning system for debugging deployed instances.

## 1. Service Worker Strategy (Offline-First)

The application currently uses a "Local-First" data strategy (IndexedDB). We will extend this to the application code itself using a **Service Worker**.

### Location
`src/service-worker.ts` (SvelteKit native support).

### Caching Logic
We will utilize the `$service-worker` module which provides access to the build manifest.

1.  **Precaching (Install Event)**
    *   **Cache Name**: `app-v${version}` (where `version` is the timestamp-based build ID provided by SvelteKit).
    *   **Assets**:
        *   `build`: The application code (JS/CSS) generated by Vite.
        *   `files`: Static assets in `/static` (images, icons).
        *   `prerendered`: Any prerendered HTML pages.
    *   **Behavior**: Immediately cache all these files during the `install` phase.

2.  **Cleanup (Activate Event)**
    *   Delete any caches that do not match the current `version` string to prevent storage bloat and ensure users get the latest code.

3.  **Fetch Handling (Interception)**
    *   **Navigation (HTML)**: **Cache-First (Stale-While-Revalidate)**.
        *   **Strategy**: Serve the cached index.html immediately for instant load.
        *   **Background Update**:
            *   The Service Worker checks for a new byte-identical build manifest in the background.
            *   If a new version is found, it downloads the new assets into a temporary cache.
            *   Once downloaded, it posts a message to the client: `{ type: 'UPDATE_READY' }`.
    *   **Assets (JS/CSS/Images)**: **Cache-First**.
        *   Serve from cache immediately.
        *   Since assets are hashed (e.g., `app.a1b2.js`), we don't need to revalidate them individually. New HTML points to new assets.
    *   **API / Data Requests (Google Sheets)**: **Network Only / Ignored**.
        *   The `SyncManager` and `IndexedDB` layer already handle data offline. The SW should explicitly **ignore** requests to `sheets.googleapis.com` or other data endpoints to avoid interfering with the application's own robust error handling and retry logic.

## 2. Versioning Strategy

We will use Vite's build process to inject version details, allowing us to trace exactly which commit is running on a device.

### Build-Time Variables
We will define the following variables in `vite.config.ts` using the `define` option or `import.meta.env` (via `process.env` injection).

*   `VITE_APP_VERSION`: From `package.json`.
*   `VITE_APP_COMMIT_HASH`: `git rev-parse --short HEAD`
*   `VITE_APP_BUILD_DATE`: `new Date().toISOString()`
*   `VITE_APP_DIRTY_FLAG`: `git status --porcelain` (check if non-empty).

### Version String Helper
A utility function `appVersion()` will construct the display string:

```typescript
// Example Output: "Food Tracker v1.0.1 (2024-01-20 ⚠ a1b2c3)"
export function getAppVersion() {
  const v = import.meta.env.VITE_APP_VERSION;
  const hash = import.meta.env.VITE_APP_COMMIT_HASH;
  const date = new Date(import.meta.env.VITE_APP_BUILD_DATE).toLocaleDateString();
  const dirty = import.meta.env.VITE_APP_DIRTY_FLAG ? '⚠ ' : '';
  
  return `Food Tracker v${v} (${date} ${dirty}${hash})`;
}
```

### Implementation in Vite
We will use `child_process.execSync` in `vite.config.ts` to fetch git info synchronously during the build config step.

## 3. UI Integration

We will expose this version information in the **Network Settings** screen (`src/routes/settings/network/+page.svelte`).

### New Section: "Application Info"
Added to the bottom of the Network Settings page.

*   **Version**: Displays the string from `getAppVersion()`.
*   **Update Status**:
    *   **Icon**:
        *   Standard State: "Cloud + Check" (Synced & Current).
        *   Update Ready State: **New "Update" Icon** (e.g., Download/Refresh arrow, possibly green/pulsing).
    *   **Behavior**:
        *   The icon appears/lights up *only* after the Service Worker has finished downloading the new version in the background.
        *   **Interaction**: Tapping the "Update" icon triggers `messageSW({ type: 'SKIP_WAITING' })` followed by `window.location.reload()`, instantly swapping to the new version.
*   **Storage**:
    *   "App Cache": Size of the cache storage (via `navigator.storage.estimate()`).
    *   "Local Database": Size of IndexedDB.

## 4. Verification Plan

1.  **Build Verification**: Run `npm run build` and inspect the generated output to ensure environment variables are replaced with literals.
2.  **Offline Shell**:
    *   Open app.
    *   Go to Network tab, set "Offline".
    *   Reload page.
    *   **Expectation**: App loads successfully (200 OK from ServiceWorker).
3.  **Network Silence**:
    *   Reload page (Online).
    *   **Expectation**: 0 requests to server for JS/CSS/Images (served from Disk Cache or Service Worker). Only data requests (if any sync happens) should hit the network.
4.  **Version Display**:
    *   Navigate to `/settings/network`.
    *   **Expectation**: See meaningful version string (e.g., hash matches current git commit).
