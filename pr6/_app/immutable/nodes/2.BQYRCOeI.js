import{a as T,f as A}from"../chunks/D-0s749m.js";import{P as q,l as E,Y as B,W as K,S as V,X as R,Z as X,$ as Z,V as $,T as k,k as O,U as y,R as C}from"../chunks/CFO0DM1P.js";import{e as G,s as J}from"../chunks/DDo-h9W_.js";import{i as Q}from"../chunks/BssfcsMa.js";import{h as ee}from"../chunks/CjodL7ei.js";import{s as h,p as U,v as te}from"../chunks/ChEBddFq.js";import{g as oe}from"../chunks/C1md1mKu.js";import{b as z}from"../chunks/CHoaSRln.js";import{w as F}from"../chunks/BQ7TfXsn.js";import{s as L}from"../chunks/ChODPF-h.js";const ne=!0,Te=Object.freeze(Object.defineProperty({__proto__:null,prerender:ne},Symbol.toStringTag,{value:"Module"})),se={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_GOOGLE_OAUTH_ID:"604496276072-po6pvcent5ph93oh569cinl7getgab2f.apps.googleusercontent.com"},ae=se&&"604496276072-po6pvcent5ph93oh569cinl7getgab2f.apps.googleusercontent.com"||void 0,D=["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/spreadsheets"].join(" "),l=F({token:null,ready:!1}),re=F(null);let v,a=null,p=null;const x="workouts_access_token",I="workouts_token_expiry",M=300;let w=null,S=null;function ie(t){const e=localStorage.getItem(x),o=localStorage.getItem(I);if(document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&le()}),e&&o){const c=parseInt(o),f=Date.now(),m=2880*60*1e3;if(f<c){a=e,l.update(g=>({...g,token:e})),t(a),L(a),window._authReady=!0,l.update(g=>({...g,ready:!0}));const d=(c-f)/1e3;P(d)}else f<c+m?(window._authReady=!0,l.update(d=>({...d,ready:!0})),b()):(N(),window._authReady=!0,l.update(d=>({...d,ready:!0})))}let i=0;const u=window.google;if(typeof u<"u"&&u.accounts){W(t);return}const _=setInterval(()=>{const c=window.google;typeof c<"u"&&c.accounts?(clearInterval(_),W(t)):(i++,i>50&&(clearInterval(_),console.error("Google Identity Services script failed to load.")))},100)}function W(t){const e=window.google;try{v=e.accounts.oauth2.initTokenClient({client_id:ae,scope:D,callback:o=>{ce(o,t)}})}catch(o){console.error("[Auth] initTokenClient failed",o)}window._authReady=!0,l.update(o=>({...o,ready:!0}))}function ce(t,e){if(t.error){console.error("[Auth] Token request failed:",t.error),N(),window.location.href=`${z}/`;return}a=t.access_token;const o=t.expires_in||3599,i=Date.now()+o*1e3;localStorage.setItem(x,a),localStorage.setItem(I,i.toString()),l.update(u=>({...u,token:a})),L(a),S&&(S(a),S=null,w=null),e(a),P(o)}function P(t,e){p&&(clearTimeout(p),p=null);const o=(t-M)*1e3;o<=0?b():p=setTimeout(()=>{b()},o)}function le(t){const e=localStorage.getItem(I);if(!e)return;const i=(parseInt(e)-Date.now())/1e3;i<M?b():P(i)}function b(){return w||(v?(w=new Promise(t=>{S=t}),v.requestAccessToken({prompt:"",scope:D}),w):Promise.resolve(null))}function ue(){v?v.requestAccessToken({prompt:"consent",scope:D}):console.error("Google Identity Services not initialized yet")}function N(){const t=a;a=null,p&&clearTimeout(p),localStorage.removeItem(x),localStorage.removeItem(I),l.update(o=>({...o,token:null}));const e=window.google;typeof e<"u"&&e.accounts&&t&&e.accounts.oauth2.revoke(t,()=>{})}async function de(){if(!a)return null;try{const t=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${a}`}});if(t.ok){const e=await t.json();return re.set({name:e.name,email:e.email,picture:e.picture,id:e.sub}),{name:e.name,email:e.email,picture:e.picture,id:e.sub}}}catch(t){console.error("Failed to fetch user info",t)}return null}var pe=A('<div class="auth-container"><button data-testid="sign-in-btn" class="svelte-1uha8ag">Sign In with Google</button></div>'),fe=A('<div class="dashboard-container"><p> </p> <button data-testid="start-workout-btn" class="svelte-1uha8ag">Start Workout</button></div>'),me=A('<main class="svelte-1uha8ag"><h1>Workouts</h1> <!></main>');function Ee(t,e){q(e,!0);let o=R(!1),i=R("User"),u=R(!1);const _=h.subscribe(()=>{const n=h.getState();E(o,n.workout.isAuthenticated,!0),n.workout.user&&E(i,n.workout.user.name,!0)});B(()=>{window.store=h;const n=l.subscribe(async s=>{if(E(u,s.ready,!0),s.token){const r=await de();r&&h.dispatch(U({type:"auth/login",payload:{user:{id:r.id||r.email,name:r.name,email:r.email},timestamp:new Date().toISOString(),accessToken:s.token}}))}});return ie(s=>{console.log("Auth Initialized",s)}),()=>{n()}}),K(()=>{_()});function c(){ue()}function f(){const n=window.__TEST_MODE__?"test-workout-id":te();h.dispatch(U({type:"workout/start",payload:{workoutId:n,timestamp:new Date().toISOString()}})),oe(`${z}/workout/${n}`)}var m=me();ee("1uha8ag",n=>{X(()=>{Z.title="Workouts"})});var d=$(k(m),2);{var g=n=>{var s=pe(),r=k(s);y(s),C(()=>r.disabled=!O(u)),G("click",r,c),T(n,s)},Y=n=>{var s=fe(),r=k(s),j=k(r);y(r);var H=$(r,2);y(s),C(()=>J(j,`Welcome, ${O(i)??""}`)),G("click",H,f),T(n,s)};Q(d,n=>{O(o)?n(Y,!1):n(g)})}y(m),T(t,m),V()}export{Ee as component,Te as universal};
